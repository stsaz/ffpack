/** ffpack: .7z tester
2021, Simon Zolin */

#include <ffpack/7z-read.h>
#include <test/test.h>

#define fflog(fmt, ...)  (void) printf(fmt "\n", ##__VA_ARGS__)

const ffbyte z7data[] = {
0x37,0x7a,0xbc,0xaf,0x27,0x1c,0x00,0x04,0xae,0x77,0xc2,0xa0,0xa2,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x22,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x21,0x44,0xa5,0xbb,
0x01,0x00,0x14,0x64,0x61,0x74,0x61,0x2d,0x64,0x69,0x72,0x66,0x69,0x6c,0x65,0x64,
0x61,0x74,0x61,0x2d,0x66,0x69,0x6c,0x65,0x00,0x00,0x00,0x81,0x33,0x07,0xae,0x0f,
0xcf,0x92,0x6e,0x60,0x0f,0xeb,0xea,0x9c,0xbf,0x36,0x3d,0xfe,0x71,0xca,0x51,0xf2,
0x01,0xb6,0xf1,0x3e,0xcc,0x29,0x76,0x3c,0xe9,0x41,0xed,0xb4,0xe2,0x91,0xa0,0x75,
0xe7,0x3c,0xe5,0x45,0xb4,0xde,0xb1,0xcb,0xb7,0x89,0x49,0x81,0xc3,0x4f,0x11,0x17,
0x8d,0x7e,0xa3,0x2c,0xff,0xf4,0xb9,0x35,0x1d,0x04,0x11,0x2a,0xbc,0xfb,0xcc,0xef,
0x96,0xb0,0x4b,0x91,0x97,0x75,0x6e,0x45,0xb9,0x7c,0x4b,0x74,0xb3,0x14,0x40,0x6d,
0xcf,0xa7,0x65,0xa5,0x20,0x5f,0xe0,0xbc,0x5e,0x42,0x4a,0x99,0xfe,0x54,0x2a,0xc8,
0x11,0x00,0xef,0x1c,0xe3,0xcc,0x27,0xa8,0x0b,0xe8,0xc1,0x2d,0x1c,0xdc,0x3e,0xf7,
0x35,0xf6,0xc3,0xb4,0x21,0xa8,0xcc,0x87,0x50,0x94,0x63,0x4a,0x27,0x6f,0x08,0x60,
0x00,0x00,0x17,0x06,0x19,0x01,0x09,0x80,0x89,0x00,0x07,0x0b,0x01,0x00,0x01,0x23,
0x03,0x01,0x01,0x05,0x5d,0x00,0x10,0x00,0x00,0x0c,0x80,0xb6,0x0a,0x01,0x8b,0x60,
0x43,0x74,0x00,0x00,
};

struct file {
	const char *name;
	ffuint attr;
	const char *data;
};

static struct file contents[] = {
	{ "dir/dirfile", 0x20, "data-dirfile" },
	{ "file.txt", 0x20, "data-file" },
	{ "dir", 0x10, "" },
	{ "empty-file", 0x20, "" },
};

static void z7log(void *udata, ffuint level, ffstr msg)
{
	(void)udata; (void)level;
	if (0)
		fflog("%.*s", (int)msg.len, msg.ptr);
}

void test_7z_read(const ffvec *buf)
{
	ffstr in = {}, out;
	ffuint off = 0;
	ffvec uncomp = {};
	int ifile = 0;
	struct file *ifi;
	const ff7zread_fileinfo *fi;

	ff7zread z = {};
	z.log = z7log;
	z.udata = NULL;
	ff7zread_open(&z);

	for (;;) {
		int r = ff7zread_process(&z, &in, &out);
		switch (r) {
		case FF7ZREAD_MORE:
			ffstr_set2(&in, buf);
			ffstr_shift(&in, off);
			off += buf->len;
			break;

		case FF7ZREAD_SEEK:
			off = ff7zread_offset(&z);
			ffstr_set2(&in, buf);
			ffstr_shift(&in, off);
			break;

		case FF7ZREAD_FILEHEADER:
			fi = ff7zread_nextfile(&z);
			if (fi == NULL) {
				xieq(ifile, FF_COUNT(contents));
				goto end;
			}
			ifi = &contents[ifile];
			xseq(&fi->name, ifi->name);
			xieq(fi->size, ffsz_len(ifi->data));
			xieq(fi->attr, ifi->attr);
			break;

		case FF7ZREAD_DATA:
			ffvec_add2T(&uncomp, &out, char);
			break;

		case FF7ZREAD_FILEDONE:
			ifi = &contents[ifile++];
			xseq((ffstr*)&uncomp, ifi->data);
			ffvec_free(&uncomp);
			break;

		case FF7ZREAD_ERROR:
			// ff7zread_error();
			x(0);
			break;

		default:
			x(0);
		}
	}

end:
	ff7zread_close(&z);
}

void test_7z()
{
	ffvec buf = {};
	ffvec_alloc(&buf, 4096, 1);
	ffvec_addT(&buf, z7data, sizeof(z7data), char);
	test_7z_read(&buf);
	ffvec_free(&buf);
}
